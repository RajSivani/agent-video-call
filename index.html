<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Video Call</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
      text-align: center;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    h2 {
      color: #333;
      font-size: 18px;
    }
    video {
      width: 100%;
      max-width: 400px;
      height: 200px;
      background-color: #000;
      border-radius: 8px;
      object-fit: cover;
      margin: 10px auto;
    }
    button {
      padding: 8px 16px;
      margin: 5px;
      background-color: #e8663d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .status {
      font-size: 12px;
      font-weight: bold;
      margin: 10px 0;
    }
    .status.success {
      color: #4CAF50;
    }
    .status.error {
      color: #e8663d;
    }
    .notification {
      margin: 10px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h2>Agent Video Call</h2>
  <div id="notification" class="notification" style="display: none;">
    <p>Incoming video call. Contact ID: <span id="contactId"></span></p>
    <button id="acceptCall">Accept Call</button>
    <button id="rejectCall">Reject Call</button>
  </div>
  <video id="agent-video" autoplay playsinline></video>
  <div class="status success" id="status">Waiting for incoming calls...</div>
  <div>
    <button id="toggleVideo" disabled>Turn On Video</button>
    <button id="toggleMute" disabled>Mute</button>
    <button id="endSession" disabled>End Call</button>
  </div>

  <script src="https://unpkg.com/amazon-chime-sdk-js@latest/dist/amazon-chime-sdk.min.js"></script>
  <script>
    const { DefaultMeetingSession, ConsoleLogger, LogLevel, DefaultDeviceController, MeetingSessionConfiguration } = window['amazon-chime-sdk-js'];
    let meetingSession = null;
    let audioElement = null;
    let isVideoOn = false;
    let isMuted = false;
    let currentContactId = null;

    const statusElement = document.getElementById('status');
    const notificationElement = document.getElementById('notification');
    const contactIdElement = document.getElementById('contactId');
    const acceptButton = document.getElementById('acceptCall');
    const rejectButton = document.getElementById('rejectCall');
    const videoButton = document.getElementById('toggleVideo');
    const muteButton = document.getElementById('toggleMute');
    const endButton = document.getElementById('endSession');
    const videoElement = document.getElementById('agent-video');

    function updateStatus(message, isError = false) {
      statusElement.textContent = message;
      statusElement.className = `status ${isError ? 'error' : 'success'}`;
    }

    function showNotification(contactId) {
      currentContactId = contactId;
      contactIdElement.textContent = contactId;
      notificationElement.style.display = 'block';
      updateStatus('Incoming call received');
    }

    function hideNotification() {
      notificationElement.style.display = 'none';
      currentContactId = null;
      updateStatus('Waiting for incoming calls...');
    }

   async function startAgentSession(contactId) {
  try {
    updateStatus('Connecting...');
    const response = await fetch('https://your-backend.com/api/agent-webrtc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contactId }),
    });
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Failed to start call');

    const { Meeting, AgentAttendee } = data.connectionData;
    const logger = new ConsoleLogger('AgentLogs', LogLevel.INFO);
    const deviceController = new DefaultDeviceController(logger);
    const configuration = new MeetingSessionConfiguration(Meeting, AgentAttendee);
    meetingSession = new DefaultMeetingSession(configuration, logger, deviceController);

    audioElement = document.createElement('audio');
    audioElement.autoplay = true;
    document.body.appendChild(audioElement);
    await meetingSession.audioVideo.bindAudioElement(audioElement);

    // Check camera permissions
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop()); // Release the stream
      const videoInputDevices = await deviceController.listVideoInputDevices();
      if (videoInputDevices.length > 0) {
        await deviceController.chooseVideoInputDevice(videoInputDevices[0].deviceId);
        meetingSession.audioVideo.startLocalVideoTile();
        const localTile = meetingSession.audioVideo.getLocalVideoTile();
        if (localTile && videoElement) {
          meetingSession.audioVideo.bindVideoElement(localTile.state().tileId, videoElement);
          isVideoOn = true;
          videoButton.textContent = 'Turn Off Video';
          updateStatus('Video enabled');
        } else {
          updateStatus('No video tile available', true);
        }
      } else {
        updateStatus('No camera detected', true);
      }
    } catch (err) {
      console.error('Camera access error:', err);
      updateStatus('Camera access denied or no camera available', true);
    }

    meetingSession.audioVideo.start();
    updateStatus('Connected to customer');
    videoButton.disabled = false;
    muteButton.disabled = false;
    endButton.disabled = false;
    hideNotification();
  } catch (err) {
    console.error('Error starting session:', err);
    updateStatus('Failed to connect: ' + err.message, true);
    hideNotification();
  }
}
    async function toggleVideo() {
      if (!meetingSession) return;
      try {
        if (isVideoOn) {
          meetingSession.audioVideo.stopLocalVideoTile();
          isVideoOn = false;
          videoButton.textContent = 'Turn On Video';
          updateStatus('Video turned off');
        } else {
          const videoInputDevices = await meetingSession.audioVideo.listVideoInputDevices();
          if (videoInputDevices.length > 0) {
            await meetingSession.audioVideo.chooseVideoInputDevice(videoInputDevices[0].deviceId);
            meetingSession.audioVideo.startLocalVideoTile();
            const localTile = meetingSession.audioVideo.getLocalVideoTile();
            if (localTile && videoElement) {
              meetingSession.audioVideo.bindVideoElement(localTile.state().tileId, videoElement);
              isVideoOn = true;
              videoButton.textContent = 'Turn Off Video';
              updateStatus('Video turned on');
            }
          } else {
            updateStatus('No camera detected', true);
          }
        }
      } catch (err) {
        console.error('Error toggling video:', err);
        updateStatus('Error toggling video', true);
      }
    }

    async function toggleMute() {
      if (!meetingSession) return;
      try {
        if (isMuted) {
          const audioInputDevices = await meetingSession.audioVideo.listAudioInputDevices();
          if (audioInputDevices.length > 0) {
            await meetingSession.audioVideo.chooseAudioInputDevice(audioInputDevices[0].deviceId);
            isMuted = false;
            muteButton.textContent = 'Mute';
            updateStatus('Microphone unmuted');
          }
        } else {
          await meetingSession.audioVideo.stopAudioInput();
          isMuted = true;
          muteButton.textContent = 'Unmute';
          updateStatus('Microphone muted');
        }
      } catch (err) {
        console.error('Error toggling mute:', err);
        updateStatus('Error toggling mute', true);
      }
    }

    function endSession() {
      if (meetingSession) {
        meetingSession.audioVideo.stop();
        if (audioElement) {
          audioElement.pause();
          document.body.removeChild(audioElement);
          audioElement = null;
        }
        meetingSession = null;
        isVideoOn = false;
        isMuted = false;
        videoButton.textContent = 'Turn On Video';
        muteButton.textContent = 'Mute';
        updateStatus('Call ended');
        videoButton.disabled = true;
        muteButton.disabled = true;
        endButton.disabled = true;
      }
    }

    // WebSocket for notifications
    const ws = new WebSocket('wss://your-backend.com/ws');
    ws.onopen = () => console.log('WebSocket connected');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'newCall' && data.contactId) {
        showNotification(data.contactId);
      }
    };
    ws.onclose = () => {
      console.log('WebSocket disconnected');
      updateStatus('WebSocket disconnected, trying to reconnect...', true);
      setTimeout(() => window.location.reload(), 5000);
    };
    ws.onerror = (err) => console.error('WebSocket error:', err);

    // Fallback: Polling
    function pollForCalls() {
      fetch('https://your-backend.com/api/check-calls')
        .then(res => res.json())
        .then(data => {
          if (data.contactId) {
            showNotification(data.contactId);
          }
        })
        .catch(err => console.error('Polling error:', err));
    }
    setInterval(pollForCalls, 5000);

    acceptButton.addEventListener('click', () => {
      if (currentContactId) {
        startAgentSession(currentContactId);
      }
    });
    rejectButton.addEventListener('click', () => {
      hideNotification();
      fetch('https://your-backend.com/api/reject-call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contactId: currentContactId }),
      });
    });
    videoButton.addEventListener('click', toggleVideo);
    muteButton.addEventListener('click', toggleMute);
    endButton.addEventListener('click', endSession);
  </script>
</body>

</html>
