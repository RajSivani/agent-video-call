<!DOCTYPE html>
<html>
<head>
  <title>Agent Video Call</title>
  <script src="https://unpkg.com/amazon-chime-sdk-js@3.x/dist/amazon-chime-sdk.min.js"></script>
  <style>
    video { width: 100%; max-width: 640px; height: auto; background: black; }
    #controls { margin-top: 10px; }
    button { margin: 5px; padding: 10px; }
    input { padding: 10px; margin: 5px; }
  </style>
</head>
<body>
  <input id="contactId" type="text" placeholder="Enter contactId" />
  <button id="join-call">Join Call</button>
  <video id="agent-video" autoplay playsinline></video>
  <div id="controls">
    <button id="end-call">End Call</button>
    <button id="toggle-mute">Mute</button>
    <button id="toggle-video">Turn On Video</button>
  </div>
  <script>
    const API_BASE_URL = 'https://your-api-id.execute-api.us-west-2.amazonaws.com/dev'; // Replace with API Gateway URL
    let meetingSession, deviceController, isMuted = false, isVideoOn = false;

    document.getElementById('join-call').addEventListener('click', async () => {
      const contactId = document.getElementById('contactId').value;
      if (!contactId) {
        alert('Please enter a contactId');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/agent-webrtc`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contactId }),
        });
        const { success, connectionData } = await response.json();
        if (!success) throw new Error(connectionData.error || 'Failed to join call');

        const { Meeting, AgentAttendee } = connectionData;
        const configuration = new window.amazonChimeSDK.MeetingSessionConfiguration(Meeting, AgentAttendee);
        const logger = new window.amazonChimeSDK.ConsoleLogger('ChimeMeetingLogs', window.amazonChimeSDK.LogLevel.INFO);
        deviceController = new window.amazonChimeSDK.DefaultDeviceController(logger);
        meetingSession = new window.amazonChimeSDK.DefaultMeetingSession(configuration, logger, deviceController);

        const audioElement = document.createElement('audio');
        audioElement.autoplay = true;
        document.body.appendChild(audioElement);
        await meetingSession.audioVideo.bindAudioElement(audioElement);

        const videoElement = document.getElementById('agent-video');
        const videoInputDevices = await deviceController.listVideoInputDevices();
        if (videoInputDevices.length > 0) {
          await deviceController.chooseVideoInputDevice(videoInputDevices[0].deviceId);
          meetingSession.audioVideo.startLocalVideoTile();
          meetingSession.audioVideo.bindVideoElement(1, videoElement);
          isVideoOn = true;
          document.getElementById('toggle-video').textContent = 'Turn Off Video';
        }

        meetingSession.audioVideo.start();
      } catch (err) {
        console.error('Error joining call:', err);
        alert('Failed to join call: ' + err.message);
      }
    });

    document.getElementById('end-call').addEventListener('click', () => {
      if (meetingSession) {
        meetingSession.audioVideo.stop();
        document.querySelectorAll('audio, video').forEach(el => el.remove());
        isMuted = false;
        isVideoOn = false;
        document.getElementById('toggle-mute').textContent = 'Mute';
        document.getElementById('toggle-video').textContent = 'Turn On Video';
      }
    });

    document.getElementById('toggle-mute').addEventListener('click', async () => {
      if (meetingSession && deviceController) {
        if (isMuted) {
          const audioInputDevices = await deviceController.listAudioInputDevices();
          if (audioInputDevices.length > 0) {
            await deviceController.startAudioInput(audioInputDevices[0].deviceId);
            document.getElementById('toggle-mute').textContent = 'Mute';
            isMuted = false;
          }
        } else {
          await deviceController.stopAudioInput();
          document.getElementById('toggle-mute').textContent = 'Unmute';
          isMuted = true;
        }
      }
    });

    document.getElementById('toggle-video').addEventListener('click', async () => {
      if (meetingSession && deviceController) {
        if (isVideoOn) {
          meetingSession.audioVideo.stopLocalVideoTile();
          document.getElementById('toggle-video').textContent = 'Turn On Video';
          isVideoOn = false;
        } else {
          const videoInputDevices = await deviceController.listVideoInputDevices();
          if (videoInputDevices.length > 0) {
            await deviceController.chooseVideoInputDevice(videoInputDevices[0].deviceId);
            meetingSession.audioVideo.startLocalVideoTile();
            meetingSession.audioVideo.bindVideoElement(1, document.getElementById('agent-video'));
            document.getElementById('toggle-video').textContent = 'Turn Off Video';
            isVideoOn = true;
          } else {
            alert('No camera detected');
          }
        }
      }
    });
  </script>
</body>
</html>
